<!DOCTYPE html>
<html lang="zh-HK" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PPLR Fit v4</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#111111">

    <style>
        /* CSS Variables */
        :root {
            --bg: #111111; --card: #1e1e1e; --text: #ffffff; --sub: #888888;
            --primary: #e63946; --accent: #457b9d; --success: #2a9d8f; --border: #333;
            --edit-mode-bg: #2d1b1b; --hint-color: #ffd166;
            --chart-line: #e63946; --chart-bg: rgba(230, 57, 70, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg); color: var(--text);
            margin: 0; padding: 20px; padding-bottom: 90px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; -webkit-tap-highlight-color: transparent;
        }

        /* ÂÇô‰ªΩÊåâÈàïÂçÄ */
        .backup-bar { width: 100%; max-width: 500px; display: flex; gap: 10px; margin-bottom: 15px; }
        .btn-tool { flex: 1; padding: 8px; background: #222; border: 1px solid #444; color: #aaa; font-size: 12px; border-radius: 8px; cursor: pointer; text-align: center; }

        /* Profile Card */
        .profile-card { width: 100%; max-width: 500px; background: linear-gradient(135deg, #1e1e1e, #2b2b2b); border-radius: 20px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); margin-bottom: 20px; border: 1px solid var(--border); position: relative; }
        .profile-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 10px; }
        .current-weight { font-size: 32px; font-weight: 800; color: var(--text); }
        .goal-label { font-size: 12px; color: var(--sub); }
        .stat-actions { display: flex; gap: 10px; position: absolute; top: 20px; right: 20px; }
        .icon-btn { font-size: 18px; cursor: pointer; background: rgba(255,255,255,0.1); width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        .stat-row { display: flex; gap: 15px; margin-top: 10px; }
        .stat-item { background: rgba(255,255,255,0.05); padding: 8px 12px; border-radius: 8px; font-size: 14px; flex: 1; text-align: center; }
        .stat-val { font-weight: bold; color: var(--primary); display: block; font-size: 16px; }
        .stat-lbl { font-size: 10px; color: var(--sub); }

        /* Schedule */
        .control-bar { width: 100%; max-width: 500px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .schedule-bar { flex: 1; display: flex; background: var(--card); padding: 4px; border-radius: 12px; margin-right: 10px; }
        .day-btn { flex: 1; padding: 8px 0; text-align: center; font-size: 12px; font-weight: bold; color: var(--sub); border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .day-btn.active { background: var(--primary); color: white; }
        .day-btn.rest.active { background: var(--success); }
        .edit-toggle { background: var(--card); border: 1px solid var(--border); color: var(--sub); padding: 8px 12px; border-radius: 12px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .edit-toggle.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* Workout Items */
        .workout-container { width: 100%; max-width: 500px; }
        .exercise-card { background: var(--card); border-radius: 15px; padding: 15px; margin-bottom: 15px; border-left: 4px solid var(--border); box-shadow: 0 2px 8px rgba(0,0,0,0.2); position: relative; }
        .exercise-card.completed { border-left-color: var(--success); opacity: 0.8; }
        body.editing .exercise-card { border-left-color: var(--primary); border-style: dashed; background: var(--edit-mode-bg); }
        .ex-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .ex-name { font-size: 18px; font-weight: bold; color: white; margin-bottom: 2px; }
        .ex-meta { font-size: 12px; color: var(--primary); font-weight: bold; }
        .ex-note { font-size: 12px; color: var(--sub); margin-top: 2px; font-style: italic; }
        
        /* Last Record Hint */
        .last-record-hint { font-size: 11px; color: var(--hint-color); margin-bottom: 8px; display: flex; align-items: center; gap: 5px; opacity: 0.8; }

        /* Sets Grid */
        .sets-grid { display: flex; flex-direction: column; gap: 8px; }
        body.editing .sets-grid { display: none; }
        .set-row { display: flex; align-items: center; gap: 10px; }
        .set-num { font-size: 12px; color: var(--sub); width: 15px; }
        input.record-input { background: #111; border: 1px solid var(--border); color: white; padding: 8px; border-radius: 6px; width: 60px; text-align: center; font-size: 14px; outline: none; }
        input.record-input:focus { border-color: var(--primary); }
        .check-btn { width: 30px; height: 30px; background: var(--border); border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; margin-left: auto; transition: 0.2s; }
        .check-btn.checked { background: var(--success); color: white; }

        /* Edit Controls */
        .edit-controls { display: none; margin-top: 10px; border-top: 1px dashed var(--border); padding-top: 10px; }
        body.editing .edit-controls { display: flex; flex-direction: column; gap: 8px; }
        input.edit-input { width: 100%; box-sizing: border-box; background: #000; border: 1px solid var(--border); color: white; padding: 8px; border-radius: 6px; margin-bottom: 5px; font-size: 14px;}
        .row-inputs { display: flex; gap: 5px; }
        .btn-add { width: 100%; padding: 12px; border: 2px dashed var(--sub); background: transparent; color: var(--sub); border-radius: 12px; cursor: pointer; margin-top: 10px; display: none; }
        body.editing .btn-add { display: block; }
        .btn-del { background: #ff4d4d; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; width: 100%; margin-top: 5px;}

        /* Modals & Timer */
        .timer-fab { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 24px; box-shadow: 0 5px 20px rgba(0,0,0,0.5); cursor: pointer; z-index: 100; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 200; backdrop-filter: blur(5px); }
        .modal { background: var(--card); width: 85%; max-width: 350px; padding: 25px; border-radius: 20px; text-align: center; max-height: 80vh; overflow-y: auto; }
        .timer-display { font-size: 48px; font-weight: bold; margin: 20px 0; font-variant-numeric: tabular-nums; }
        .btn { padding: 10px 20px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; margin: 5px; }
        .btn-start { background: var(--primary); color: white; }
        .btn-reset { background: var(--border); color: var(--text); }
        .stat-input { width: 100%; margin-bottom: 10px; padding: 10px; box-sizing: border-box; background: #000; border: 1px solid var(--border); color: white; border-radius: 8px;}
        
        /* History & Chart */
        .history-list { text-align: left; margin-top: 10px; max-height: 200px; overflow-y: auto; }
        .history-item { display: flex; justify-content: space-between; border-bottom: 1px dashed var(--border); padding: 10px 0; font-size: 14px; }
        .hist-date { color: var(--sub); font-size: 12px; }
        
        /* Chart Container */
        .chart-container {
            width: 100%; height: 150px; margin-bottom: 15px; 
            border-bottom: 1px solid var(--border); position: relative;
            display: flex; align-items: flex-end; justify-content: space-between;
            padding: 0 10px; box-sizing: border-box;
        }
        .chart-bar {
            width: 10px; background: var(--chart-line); border-radius: 2px 2px 0 0;
            transition: height 0.5s ease; position: relative;
        }
        .chart-label {
            position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%);
            font-size: 8px; color: var(--sub); white-space: nowrap;
        }
        .chart-val {
            position: absolute; top: -15px; left: 50%; transform: translateX(-50%);
            font-size: 9px; color: var(--text);
        }
    </style>
</head>
<body>

    <div class="backup-bar">
        <button class="btn-tool" onclick="backupData()">üì§ ÂÇô‰ªΩË≥áÊñô</button>
        <label class="btn-tool" style="display:block;">
            üì• ÊÅ¢Âæ©Ë≥áÊñô
            <input type="file" style="display:none" onchange="restoreData(this)">
        </label>
    </div>

    <div class="profile-card">
        <div class="stat-actions">
            <div class="icon-btn" onclick="openHistoryModal()">üìä</div> <!-- ÊîπÁÇ∫ÂúñË°® icon -->
            <div class="icon-btn" onclick="openStatModal()">‚úé</div>
        </div>
        <div class="profile-header">
            <div>
                <div class="current-weight" id="disp-weight">-- <span style="font-size:14px;color:#888;">kg</span></div>
                <div class="goal-label">ÁõÆÊ®ôÈ´îËÑÇ: 20% ‚Üí 15%</div>
            </div>
        </div>
        <div class="stat-row">
            <div class="stat-item">
                <span class="stat-val" id="disp-bf">--%</span>
                <span class="stat-lbl">È´îËÑÇÁéá</span>
            </div>
            <div class="stat-item">
                <span class="stat-val" id="disp-bmi">--</span>
                <span class="stat-lbl">BMI</span>
            </div>
            <div class="stat-item" onclick="resetToday()">
                <span class="stat-val">üîÑ</span>
                <span class="stat-lbl">ÈáçÁΩÆ‰ªäÊó•</span>
            </div>
        </div>
    </div>

    <div class="control-bar">
        <div class="schedule-bar">
            <div class="day-btn" id="btn-push" onclick="setMode('PUSH')">PUSH</div>
            <div class="day-btn" id="btn-pull" onclick="setMode('PULL')">PULL</div>
            <div class="day-btn" id="btn-legs" onclick="setMode('LEGS')">LEGS</div>
            <div class="day-btn rest" id="btn-rest" onclick="setMode('REST')">REST</div>
        </div>
        <div class="edit-toggle" id="btn-edit-toggle" onclick="toggleEditMode()">
            <span>‚öôÔ∏è</span> Á∑®ËºØ
        </div>
    </div>

    <div class="workout-container" id="workout-list"></div>
    <button class="btn-add" onclick="addExercise()">+ Êñ∞Â¢ûÂãï‰Ωú</button>
    <div class="timer-fab" onclick="openTimer()">‚è±Ô∏è</div>

    <!-- Modals -->
    <div class="modal-overlay" id="modal-timer">
        <div class="modal">
            <h3>‰ºëÊÅØË®àÊôÇ</h3>
            <div class="timer-display" id="timer-val">00:00</div>
            <div>
                <button class="btn btn-reset" onclick="resetTimer()">ÈáçÁΩÆ</button>
                <button class="btn btn-start" onclick="toggleTimer()" id="btn-timer-action">ÈñãÂßã</button>
            </div>
            <div style="margin-top:15px; font-size:12px; color:#888;" onclick="closeModal('modal-timer')">ÈóúÈñâË¶ñÁ™ó</div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-stats">
        <div class="modal">
            <h3>Êõ¥Êñ∞È´îÊÖã</h3>
            <label style="display:block; text-align:left; font-size:12px; margin-bottom:5px;">È´îÈáç (kg)</label>
            <input type="number" id="inp-weight" class="stat-input" step="0.1">
            <label style="display:block; text-align:left; font-size:12px; margin-bottom:5px;">È´îËÑÇ (%)</label>
            <input type="number" id="inp-bf" class="stat-input" step="0.1">
            <button class="btn btn-start" style="width:100%; margin:0;" onclick="saveStats()">ÂÑ≤Â≠ò‰∏¶Ë®òÈåÑÊó•Êúü</button>
            <div style="margin-top:10px; font-size:12px; color:#888; cursor:pointer;" onclick="closeModal('modal-stats')">ÂèñÊ∂à</div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-history">
        <div class="modal" style="max-width:400px;">
            <h3>È´îÈáçËµ∞Âã¢</h3>
            <!-- Chart Container -->
            <div class="chart-container" id="weight-chart"></div>
            
            <h4 style="margin:10px 0 5px; font-size:14px; color:#888; text-align:left;">Ê≠∑Âè≤Á¥ÄÈåÑ</h4>
            <div class="history-list" id="history-list"></div>
            <div style="margin-top:15px; font-size:12px; color:#888;" onclick="closeModal('modal-history')">ÈóúÈñâË¶ñÁ™ó</div>
        </div>
    </div>

<script>
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');

    const KEY_DATA = 'pplr_data_v2';
    const KEY_PLANS = 'pplr_plans_v2';
    const KEY_STATS_HISTORY = 'pplr_stats_history_v2';

    const DEFAULT_PLANS = {
        'PUSH': [
            { name: "Barbell Bench Press", sets: 4, repRange: "6-8", weight: "40-55kg", note: "ÊúÄÂæå‰∏ÄÁµÑ AMRAP" },
            { name: "Incline Dumbbell Press", sets: 3, repRange: "8-10", weight: "30kg", note: "" },
            { name: "Seated Overhead Press", sets: 3, repRange: "8-10", weight: "20-30kg", note: "" },
            { name: "Lateral Raise", sets: 3, repRange: "12-15", weight: "5kg", note: "È†ÇÂÅú 1s" },
            { name: "Tricep Pushdown", sets: 3, repRange: "10-12", weight: "12.5kg", note: "" },
            { name: "Dips", sets: 3, repRange: "10-12", weight: "Body", note: "Ëá™Èáç" }
        ],
        'PULL': [
            { name: "Barbell Row", sets: 4, repRange: "8-10", weight: "50kg", note: "ËÉ∏Ë≤ºËÖø" },
            { name: "Wide Grip Lat Pulldown", sets: 4, repRange: "8-12", weight: "55kg", note: "Êì†Â£ì 2s" },
            { name: "Bent-over Barbell Row", sets: 3, repRange: "8-10", weight: "40kg", note: "" },
            { name: "Face Pull", sets: 3, repRange: "12-15", weight: "12.5-15kg", note: "" },
            { name: "EZ Bar Bicep Curl", sets: 3, repRange: "10-12", weight: "14kg", note: "" },
            { name: "Hammer Curl", sets: 3, repRange: "10-12", weight: "7kg", note: "" }
        ],
        'LEGS': [
            { name: "Back Squat", sets: 4, repRange: "6-8", weight: "50-60kg", note: "Âπ≥Ë°åÊ∑±Ëπ≤" },
            { name: "Romanian Deadlift", sets: 4, repRange: "8-10", weight: "40-50kg", note: "" },
            { name: "Leg Press", sets: 3, repRange: "10-12", weight: "60kg", note: "ËÖ≥È´ò‰Ωç" },
            { name: "Leg Curl", sets: 3, repRange: "12-15", weight: "45kg", note: "" },
            { name: "Calf Raise", sets: 4, repRange: "12-15", weight: "Body", note: "Êì†Â£ì 2s" },
            { name: "Ab Wheel Rollout", sets: 3, repRange: "12-15", weight: "Body", note: "" }
        ],
        'REST': []
    };

    let userPlans = JSON.parse(localStorage.getItem(KEY_PLANS)) || DEFAULT_PLANS;
    let workoutData = JSON.parse(localStorage.getItem(KEY_DATA)) || {};
    let statsHistory = JSON.parse(localStorage.getItem(KEY_STATS_HISTORY)) || [{ date: new Date().toLocaleDateString(), weight: 67.7, bf: 20 }];
    
    let currentMode = 'PUSH';
    let todayKey = getTodayKey();
    let isEditMode = false;
    let timerInterval; let timerSeconds = 0; let isTimerRunning = false;

    init();

    function init() {
        updateStatsUI();
        let lastMode = localStorage.getItem('pplr_last_mode') || 'PUSH';
        setMode(lastMode); 
    }

    function getTodayKey() {
        const d = new Date();
        return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
    }

    function setMode(mode) {
        currentMode = mode;
        localStorage.setItem('pplr_last_mode', mode);
        document.querySelectorAll('.day-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`btn-${mode.toLowerCase()}`).classList.add('active');
        renderWorkouts();
    }

    function getLastRecord(exName) {
        const keys = Object.keys(workoutData).sort().reverse();
        for (let key of keys) {
            if (key.startsWith(todayKey)) continue; 
            const dayData = workoutData[key];
            if (dayData && dayData[exName]) {
                const sets = dayData[exName];
                const bestSet = sets.find(s => s.w > 0 && s.r > 0);
                if (bestSet) return `${bestSet.w}kg x ${bestSet.r}`;
            }
        }
        return null;
    }

    function renderWorkouts() {
        const container = document.getElementById('workout-list');
        container.innerHTML = '';

        if (currentMode === 'REST') {
            container.innerHTML = `<div style="text-align:center; padding:50px; color:#888;"><h2>üõå Rest Day</h2><p>ËÇåËÇâÊòØÂú®‰ºëÊÅØÊôÇÁîüÈï∑ÁöÑÔºÅ</p></div>`;
            return;
        }

        const exercises = userPlans[currentMode];
        const recordKey = `${todayKey}-${currentMode}`;
        const dayRecords = workoutData[recordKey] || {};

        exercises.forEach((ex, exIdx) => {
            const exRecord = dayRecords[ex.name] || [];
            const isAllDone = !isEditMode && exRecord.length === ex.sets && exRecord.every(s => s.done);
            const lastHint = getLastRecord(ex.name);
            const hintHtml = lastHint ? `<div class="last-record-hint">üî• ‰∏äÊ¨°: ${lastHint}</div>` : '';

            let html = `<div class="exercise-card ${isAllDone ? 'completed' : ''}">`;

            if (isEditMode) {
                html += `<div class="edit-controls"><label style="font-size:10px; color:#888;">Âãï‰ΩúÂêçÁ®±</label><input class="edit-input" value="${ex.name}" onchange="updatePlan(${exIdx}, 'name', this.value)"><div class="row-inputs"><div style="flex:1"><label style="font-size:10px; color:#888;">ÁµÑÊï∏</label><input class="edit-input" type="number" value="${ex.sets}" onchange="updatePlan(${exIdx}, 'sets', this.value)"></div><div style="flex:1"><label style="font-size:10px; color:#888;">‰∏ãÊï∏</label><input class="edit-input" value="${ex.repRange}" onchange="updatePlan(${exIdx}, 'repRange', this.value)"></div></div><label style="font-size:10px; color:#888;">ÈáçÈáè/ÂÇôË®ª</label><input class="edit-input" value="${ex.weight}" onchange="updatePlan(${exIdx}, 'weight', this.value)"><input class="edit-input" value="${ex.note}" onchange="updatePlan(${exIdx}, 'note', this.value)"><button class="btn-del" onclick="deleteExercise(${exIdx})">Âà™Èô§</button></div>`;
            } else {
                html += `<div class="ex-header"><div><div class="ex-name">${ex.name}</div><div class="ex-meta">${ex.sets} Sets √ó ${ex.repRange} Reps @ ${ex.weight}</div><div class="ex-note">${ex.note}</div></div></div>${hintHtml}<div class="sets-grid">`;
                
                for (let i = 0; i < ex.sets; i++) {
                    const setRec = exRecord[i] || { w: '', r: '', done: false };
                    const checkClass = setRec.done ? 'checked' : '';
                    html += `<div class="set-row"><span class="set-num">S${i+1}</span><input class="record-input" type="number" placeholder="kg" value="${setRec.w}" id="w-${exIdx}-${i}" onchange="saveInput(${exIdx}, ${i})"><input class="record-input" type="number" placeholder="reps" value="${setRec.r}" id="r-${exIdx}-${i}" onchange="saveInput(${exIdx}, ${i})"><div class="check-btn ${checkClass}" onclick="toggleSet(${exIdx}, ${i})">‚úî</div></div>`;
                }
                html += `</div>`;
            }
            html += `</div>`;
            container.innerHTML += html;
        });
    }

    // --- Smart Auto-fill Logic ---
    function toggleSet(exIdx, setIdx) {
        const exName = userPlans[currentMode][exIdx].name;
        const recordKey = `${todayKey}-${currentMode}`;
        
        saveInput(exIdx, setIdx); // Save current first

        // Smart Copy: If marking as Done, and next set exists & is empty, copy data
        const currentW = document.getElementById(`w-${exIdx}-${setIdx}`).value;
        const currentR = document.getElementById(`r-${exIdx}-${setIdx}`).value;
        
        // Ensure data struct exists for next set check
        if (!workoutData[recordKey][exName][setIdx + 1]) {
             // It might be undefined in data, let's check input element existence
             const nextWInput = document.getElementById(`w-${exIdx}-${setIdx+1}`);
             const nextRInput = document.getElementById(`r-${exIdx}-${setIdx+1}`);
             
             if (nextWInput && nextRInput) {
                 // Check if empty
                 if (nextWInput.value === "" && nextRInput.value === "") {
                     // Auto-fill visually
                     nextWInput.value = currentW;
                     nextRInput.value = currentR;
                     // Auto-save next set data
                     saveInput(exIdx, setIdx + 1);
                 }
             }
        }

        // Toggle Status
        const currentStatus = workoutData[recordKey][exName][setIdx].done;
        workoutData[recordKey][exName][setIdx].done = !currentStatus;
        localStorage.setItem(KEY_DATA, JSON.stringify(workoutData));
        
        // Re-render to update UI colors
        renderWorkouts(); 
    }

    function saveInput(exIdx, setIdx) {
        const exName = userPlans[currentMode][exIdx].name;
        const recordKey = `${todayKey}-${currentMode}`;
        if (!workoutData[recordKey]) workoutData[recordKey] = {};
        if (!workoutData[recordKey][exName]) workoutData[recordKey][exName] = [];
        const wVal = document.getElementById(`w-${exIdx}-${setIdx}`).value;
        const rVal = document.getElementById(`r-${exIdx}-${setIdx}`).value;
        if (!workoutData[recordKey][exName][setIdx]) { workoutData[recordKey][exName][setIdx] = { w: '', r: '', done: false }; }
        workoutData[recordKey][exName][setIdx].w = wVal;
        workoutData[recordKey][exName][setIdx].r = rVal;
        localStorage.setItem(KEY_DATA, JSON.stringify(workoutData));
    }

    // --- Chart Logic ---
    function renderChart() {
        const chart = document.getElementById('weight-chart');
        chart.innerHTML = '';
        
        // Use last 7 records for chart
        const data = statsHistory.slice(-7); 
        if (data.length < 2) { chart.innerHTML = '<div style="width:100%;text-align:center;font-size:12px;color:#666;">Êï∏Êìö‰∏çË∂≥‰ª•È°ØÁ§∫ÂúñË°®</div>'; return; }

        const weights = data.map(d => d.weight);
        const minW = Math.min(...weights) - 0.5;
        const maxW = Math.max(...weights) + 0.5;
        const range = maxW - minW;

        data.forEach((d, i) => {
            const barHeight = ((d.weight - minW) / range) * 100; // % height
            const bar = document.createElement('div');
            bar.className = 'chart-bar';
            bar.style.height = `${barHeight}%`;
            bar.style.width = `${100 / data.length - 5}%`;
            
            // Date Label (MM/DD)
            const dateStr = d.date.split(' ')[0].slice(0, 5); // Simplification
            bar.innerHTML = `<span class="chart-val">${d.weight}</span><span class="chart-label">${dateStr}</span>`;
            
            chart.appendChild(bar);
        });
    }

    // --- Stats & History ---
    function openHistoryModal() {
        renderChart(); // Draw chart
        const list = document.getElementById('history-list');
        list.innerHTML = '';
        [...statsHistory].reverse().forEach(item => {
            list.innerHTML += `<div class="history-item"><span class="hist-date">${item.date}</span><span style="font-weight:bold; color:white;">${item.weight}kg</span><span style="color:var(--primary);">${item.bf}%</span></div>`;
        });
        document.getElementById('modal-history').style.display = 'flex';
    }

    function updateStatsUI() {
        const latest = statsHistory[statsHistory.length - 1];
        document.getElementById('disp-weight').innerHTML = `${latest.weight} <span style="font-size:14px;color:#888;">kg</span>`;
        document.getElementById('disp-bf').innerText = `${latest.bf}%`;
        const h = 1.71; const bmi = (latest.weight / (h*h)).toFixed(1);
        document.getElementById('disp-bmi').innerText = bmi;
    }
    
    function openStatModal() {
        const latest = statsHistory[statsHistory.length - 1];
        document.getElementById('inp-weight').value = latest.weight;
        document.getElementById('inp-bf').value = latest.bf;
        document.getElementById('modal-stats').style.display = 'flex';
    }

    function saveStats() {
        const w = parseFloat(document.getElementById('inp-weight').value);
        const b = parseFloat(document.getElementById('inp-bf').value);
        if (w && b) {
            const now = new Date();
            const timeStr = `${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}`;
            statsHistory.push({ date: timeStr, weight: w, bf: b });
            localStorage.setItem(KEY_STATS_HISTORY, JSON.stringify(statsHistory));
            updateStatsUI();
            closeModal('modal-stats');
        }
    }

    // --- Standard Functions (Edit, Timer, Backup) ---
    function toggleEditMode() {
        if (currentMode === 'REST') { alert("‰ºëÊÅØÊó•ÁÑ°ÈáéÂ•ΩÊîπÔºÅ"); return; }
        isEditMode = !isEditMode;
        document.body.classList.toggle('editing', isEditMode);
        document.getElementById('btn-edit-toggle').classList.toggle('active', isEditMode);
        document.getElementById('btn-edit-toggle').innerHTML = isEditMode ? 'üíæ ÂÆåÊàê' : '‚öôÔ∏è Á∑®ËºØ';
        renderWorkouts();
    }
    function updatePlan(exIdx, field, value) { if (field === 'sets') value = parseInt(value) || 1; userPlans[currentMode][exIdx][field] = value; localStorage.setItem(KEY_PLANS, JSON.stringify(userPlans)); renderWorkouts(); }
    function addExercise() { userPlans[currentMode].push({ name: "New Exercise", sets: 3, repRange: "10-12", weight: "0kg", note: "" }); localStorage.setItem(KEY_PLANS, JSON.stringify(userPlans)); renderWorkouts(); }
    function deleteExercise(idx) { if(confirm("Á¢∫ÂÆöÂà™Èô§Ê≠§Âãï‰ΩúÔºü")) { userPlans[currentMode].splice(idx, 1); localStorage.setItem(KEY_PLANS, JSON.stringify(userPlans)); renderWorkouts(); } }
    function resetToday() { if(confirm("Á¢∫ÂÆöË¶ÅÈáçÁΩÆ‰ªäÂ§©ÁöÑË®ìÁ∑¥Á¥ÄÈåÑÂóéÔºü")) { delete workoutData[`${todayKey}-${currentMode}`]; localStorage.setItem(KEY_DATA, JSON.stringify(workoutData)); renderWorkouts(); } }
    
    function backupData() {
        const data = { workoutData, userPlans, statsHistory, timestamp: new Date().toISOString() };
        const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `PPLR_Backup_${todayKey}.json`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }
    function restoreData(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if(confirm(`ÁôºÁèæÂÇô‰ªΩÊ™îÊ°à (${data.timestamp})ÔºåÁ¢∫ÂÆöÈÇÑÂéüÔºü`)) {
                    if(data.workoutData) localStorage.setItem(KEY_DATA, JSON.stringify(data.workoutData));
                    if(data.userPlans) localStorage.setItem(KEY_PLANS, JSON.stringify(data.userPlans));
                    if(data.statsHistory) localStorage.setItem(KEY_STATS_HISTORY, JSON.stringify(data.statsHistory));
                    alert("ÈÇÑÂéüÊàêÂäüÔºÅ"); location.reload();
                }
            } catch(err) { alert("Ê™îÊ°àÊ†ºÂºèÈåØË™§"); }
        };
        reader.readAsText(file); input.value = '';
    }

    function openTimer() { document.getElementById('modal-timer').style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function toggleTimer() { if (isTimerRunning) { clearInterval(timerInterval); document.getElementById('btn-timer-action').innerText = "ÁπºÁ∫å"; isTimerRunning = false; } else { timerInterval = setInterval(() => { timerSeconds++; updateTimerDisplay(); }, 1000); document.getElementById('btn-timer-action').innerText = "Êö´ÂÅú"; isTimerRunning = true; } }
    function resetTimer() { clearInterval(timerInterval); isTimerRunning = false; timerSeconds = 0; updateTimerDisplay(); document.getElementById('btn-timer-action').innerText = "ÈñãÂßã"; }
    function updateTimerDisplay() { const m = Math.floor(timerSeconds/60).toString().padStart(2,'0'); const s = (timerSeconds%60).toString().padStart(2,'0'); document.getElementById('timer-val').innerText = `${m}:${s}`; }

</script>
</body>
</html>